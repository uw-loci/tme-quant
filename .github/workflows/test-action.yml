name: Secret Runner

on:
  workflow_call:
    secrets:
      FETCH_FDCT:
        required: true

jobs:
  run-curl:
    runs-on: ubuntu-latest
    steps:
      - name: Run command from secret
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.FETCH_FDCT }}" ]; then
            echo "::error title=Missing secret::FETCH_FDCT is empty."
            exit 1
          fi
          mkdir -p utils
          cd utils
          eval "${{ secrets.FETCH_FDCT }}"
          echo "utils/ contents:"
          ls -la
          if [ ! -f "CurveLab-2.1.3.tar.gz" ]; then
            echo "::error title=CurveLab archive missing::Expected utils/CurveLab-2.1.3.tar.gz to exist after running FETCH_FDCT."
            exit 1
          fi
          if command -v file >/dev/null 2>&1; then
            echo "CurveLab-2.1.3.tar.gz mime-type:"
            MIME="$(file -b --mime-type "CurveLab-2.1.3.tar.gz" || true)"
            echo "${MIME}"
            if [[ "${MIME}" == text/html* ]]; then
              echo "::error title=CurveLab download returned HTML::Likely a 403/redirect."
              head -n 40 "CurveLab-2.1.3.tar.gz" || true
              exit 1
            fi
          fi
